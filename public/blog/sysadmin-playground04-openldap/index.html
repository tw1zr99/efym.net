<!DOCTYPE html>
<html lang="en">
<head>
	<title>sysadmin playground part 04 | openldap | efym.net</title>
	<link rel="canonical" href="http://efym.net/">
	<link rel='alternate' type='application/rss+xml' title="efym.net RSS" href='/index.xml'>
	<link rel='stylesheet' type='text/css' href='/style.css'>
	<link rel="icon" href="/favicon.ico">
	<meta name="description" content="Recreation of a lab environment with Terraform and Ansible.
This post is part of a series, follow the links to the other parts: Sysadmin Playground Part 01 | Intro
Sysadmin Playground Part 02 | Terraform and KVM
Sysadmin Playground Part 03 | Ansible and Docker
Sysadmin Playground Part 04 | OpenLDAP
Sysadmin Playground Part 05 | Passwords and Ansible Vault
Sysadmin Playground Part 06 | Centralized Logs
Sysadmin Playground Part 07 | E-mail">
	<meta name="keywords" content="sysadmin, linux">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="robots" content="index, follow">
	<meta charset="utf-8">
</head>
<body>
<div class="topbar">
<nav class="menu">
<div class="nav-left">
 <ul>
	<li><a href="/"><img class="logo" src="/svg/efym/net.svg" alt="logo"></a></li>
  </ul>
</div>
<div class="nav-right">
 <ul>
	<li><a href="/contact">contact</a></li>
	<li><a href="/support">support</a></li>
	<li><a href="/services">services</a></li>
	<li><a href="/blog">blog</a></li>
	<li><a href="/about">about</a></li>
  </ul>
</div>
</nav>
</div>
<main>
<header><h1>Sysadmin Playground Part 04 | OpenLDAP</h1></header>
<article>
<p class="date">August 16, 2021</p>
<p>Recreation of a lab environment with Terraform and Ansible.</p>
<hr>
<strong>This post is part of a series, follow the links to the other parts:</strong>
<br>


<a href="/blog/sysadmin-playground01-intro/">Sysadmin Playground Part 01 | Intro</a><br>

<a href="/blog/sysadmin-playground02-terraform-kvm/">Sysadmin Playground Part 02 | Terraform and KVM</a><br>

<a href="/blog/sysadmin-playground03-ansible-docker/">Sysadmin Playground Part 03 | Ansible and Docker</a><br>

<a href="/blog/sysadmin-playground04-openldap/">Sysadmin Playground Part 04 | OpenLDAP</a><br>

<a href="/blog/sysadmin-playground05-passwords-ansible-vault/">Sysadmin Playground Part 05 | Passwords and Ansible Vault</a><br>

<a href="/blog/sysadmin-playground06-centralized-logs/">Sysadmin Playground Part 06 | Centralized Logs</a><br>

<a href="/blog/sysadmin-playground07-email/">Sysadmin Playground Part 07 | E-mail</a><br>

<a href="/blog/sysadmin-playground08-nfs/">Sysadmin Playground Part 08 | NFS</a><br>


<hr>
<h2 id="quick-ping-check-with-ansible-ad-hoc-command">Quick ping check with Ansible ad-hoc command</h2>
<p>Let&rsquo;s run a ping test with <strong>Ansible</strong> to make sure all our VMs are running fine first:</p>
<p><strong><code>$ ansible all -m ping</code></strong></p>
<pre tabindex="0"><code>cutxo | SUCCESS =&gt; {
    &#34;ansible_facts&#34;: {
        &#34;discovered_interpreter_python&#34;: &#34;/usr/bin/python3&#34;
    },
    &#34;changed&#34;: false,
    &#34;ping&#34;: &#34;pong&#34;
}
doris | SUCCESS =&gt; {
    &#34;ansible_facts&#34;: {
        &#34;discovered_interpreter_python&#34;: &#34;/usr/bin/python3&#34;
    },
    &#34;changed&#34;: false,
    &#34;ping&#34;: &#34;pong&#34;
}
cutxn | SUCCESS =&gt; {
    &#34;ansible_facts&#34;: {
        &#34;discovered_interpreter_python&#34;: &#34;/usr/bin/python3&#34;
    },
    &#34;changed&#34;: false,
    &#34;ping&#34;: &#34;pong&#34;
}
</code></pre><p>Note the <code>&quot;ping&quot;: &quot;pong&quot;</code> response on every one of our virtual machines, this means they are up and <strong>Ansible</strong> is able to communicate with them.</p>
<h2 id="configuration-of-ldap-server-container">Configuration of LDAP server container</h2>
<p>To run our <strong>LDAP</strong> server we will use a master/master configuration of <a href="https://openldap.org">OpenLDAP</a> on the <strong>cutxn</strong> and <strong>cutxo</strong> virtual machines. We&rsquo;ll use <strong>Ansible</strong> to deploy it so we need to set up the tasks on the <strong>openldap</strong> role we made in the previous chapter.</p>
<p>Modify the content of <code>/path/to/ansible/roles/openldap/tasks/main.yml</code> by appending these lines:</p>
<p><strong>Lines to append</strong> to <code>roles/openldap/tasks/main.yml</code></p>
<pre tabindex="0"><code>- name: Set /srv/openldap permissions
  when: &#34;ansible_hostname == &#39;cutxn&#39; or ansible_hostname == &#39;cutxo&#39;&#34;
  file:
    dest: &#34;/srv/openldap&#34;
    owner: &#34;root&#34;
    group: &#34;root&#34;
    mode: &#34;0755&#34;
    state: &#34;directory&#34;

- name: Set /srv/openldap/ldap permissions
  when: &#34;ansible_hostname == &#39;cutxn&#39; or ansible_hostname == &#39;cutxo&#39;&#34;
  file:
    dest: &#34;/srv/openldap/ldap&#34;
    owner: &#34;911&#34;
    group: &#34;911&#34;
    mode: &#34;0755&#34;
    state: &#34;directory&#34;

- name: Set /srv/openldap/slapd.d permissions
  when: &#34;ansible_hostname == &#39;cutxn&#39; or ansible_hostname == &#39;cutxo&#39;&#34;
  file:
    dest: &#34;/srv/openldap/slapd.d&#34;
    owner: &#34;911&#34;
    group: &#34;911&#34;
    mode: &#34;0755&#34;
    state: &#34;directory&#34;

- name: Copy openldap ldifs into /srv/openldap/
  when: &#34;ansible_hostname == &#39;cutxn&#39; or ansible_hostname == &#39;cutxo&#39;&#34;
  copy:
    src: &#34;openldap/ldifs&#34;
    dest: &#34;/srv/openldap/&#34;
    owner: &#34;911&#34;
    group: &#34;911&#34;

- name: Set /srv/openldap/certs permissions
  when: &#34;ansible_hostname == &#39;cutxn&#39; or ansible_hostname == &#39;cutxo&#39;&#34;
  file:
    dest: &#34;/srv/openldap/certs&#34;
    owner: &#34;911&#34;
    group: &#34;911&#34;
    mode: &#34;0755&#34;
    state: &#34;directory&#34;

- name: Copy pygrn.lab-CA.crt into /srv/openldap/certs/
  when: &#34;ansible_hostname == &#39;cutxn&#39; or ansible_hostname == &#39;cutxo&#39;&#34;
  copy:
    src: &#34;CA/pygrn.lab-CA.crt&#34;
    dest: &#34;/srv/openldap/certs/&#34;
    owner: &#34;911&#34;
    group: &#34;911&#34;
    mode: &#34;0600&#34;

- name: Copy openldap.crt into /srv/openldap/certs/
  when: &#34;ansible_hostname == &#39;cutxn&#39; or ansible_hostname == &#39;cutxo&#39;&#34;
  copy:
    src: &#34;CA/openldap.crt&#34;
    dest: &#34;/srv/openldap/certs/&#34;
    owner: &#34;911&#34;
    group: &#34;911&#34;
    mode: &#34;0600&#34;

- name: Copy openldap.key into /srv/openldap/certs/
  when: &#34;ansible_hostname == &#39;cutxn&#39; or ansible_hostname == &#39;cutxo&#39;&#34;
  copy:
    src: &#34;CA/openldap.key&#34;
    dest: &#34;/srv/openldap/certs/&#34;
    owner: &#34;911&#34;
    group: &#34;911&#34;
    mode: &#34;0600&#34;

- name: OpenLDAP container
  when: &#34;ansible_hostname == &#39;cutxn&#39; or ansible_hostname == &#39;cutxo&#39;&#34;
  docker_container:
    name: &#39;{{ ansible\_hostname }}-openldap&#39;
    restart\_policy: &#34;always&#34;
    image: &#39;osixia/openldap:latest&#39;
    hostname: &#39;{{ ansible\_hostname }}.pygrn.lab&#39;
    published\_ports:
      - &#34;389:389&#34;
    env:
      LDAP_BASE_DN: &#34;dc=pygrn,dc=lab&#34;
      LDAP_ORGANISATION: &#34;Pygrn Lab&#34;
      LDAP_DOMAIN: &#34;pygrn.lab&#34;
      LDAP_ADMIN_PASSWORD: &#34;nyaa&#34;
      LDAP_CONFIG_PASSWORD: &#34;nyaa&#34;
      LDAP_READONLY_USER: &#34;true&#34;
      LDAP_READONLY_USER_USERNAME: &#34;readonly&#34;
      LDAP_READONLY_USER_PASSWORD: &#34;aayn&#34;
      LDAP_TLS: &#34;true&#34;
      LDAP_TLS_VERIFY_CLIENT: &#34;try&#34;
      LDAP_TLS_CA\_CRT_FILENAME: &#34;pygrn.lab-CA.crt&#34;
      LDAP_TLS_CRT_FILENAME: &#34;openldap.crt&#34;
      LDAP_TLS_KEY_FILENAME: &#34;openldap.key&#34;
      LDAP_REPLICATION: &#34;true&#34;
      LDAP_REPLICATION_HOSTS: &#34;#PYTHON2BASH:[&#39;ldap://cutxn.pygrn.lab&#39;,&#39;ldap://cutxo.pygrn.lab&#39;]&#34;
    volumes:
      - &#34;/etc/timezone:/etc/timezone:ro&#34;
      - &#34;/etc/localtime:/etc/localtime:ro&#34;
      - &#34;/srv/openldap/ldap:/var/lib/ldap&#34;
      - &#34;/srv/openldap/slapd.d:/etc/ldap/slapd.d&#34;
      - &#34;/srv/openldap/certs:/container/service/slapd/assets/certs&#34;
</code></pre><p>The first few tasks create <code>/srv/openldap</code> and some sub-directories, set their permissions, then copy certificate files and two ldif files (<code>auth_and_tls.ldif</code> and <code>groups_and_users.ldif</code>â€”content of these below) into them to modify the <strong>LDAP</strong> server.<br>
The last task defines the <strong>openldap</strong> container.<br>
The image I&rsquo;m using is <a href="https://github.com/osixia/docker-openldap">docker-openldap</a>, there is decent documentation on their page.</p>
<p>Most of the environment variables defined in this container are very similar to the ones defined in the <strong>php</strong> we made previously. We define some <strong>LDAP</strong> parameters, credentials, certificates and the DNS address (made resolvable by the local zone we did in <a href="/blog/sysadmin-playground02">Part 2</a>) of the two hosts serving as master/master.<br>
This container will get deployed to both <strong>cutxn</strong> and <strong>cutxo</strong> since we&rsquo;re using this conditional <code>when: &quot;ansible_hostname == 'cutxn' or ansible_hostname == 'cutxo'&quot;</code> just like in the previous container, only this time it specifies two hostnames and will get deployed to both.</p>
<p>Here&rsquo;s the output of using <strong>cat</strong> on the ldif files:</p>
<p><strong><code>$ cat files/openldap/ldifs/auth_and_tls.ldif</code></strong></p>
<pre tabindex="0"><code># disallow anonymous bind
dn: cn=config
changetype: modify
add: olcDisallows
olcDisallows: bind_anon

# require authentication
dn: olcDatabase={-1}frontend,cn=config
changetype: modify
add: olcRequires
olcRequires: authc

# require tls
dn: cn=config
changetype:  modify
add: olcSecurity
olcSecurity: tls=1
</code></pre><p><strong><code>$ cat files/openldap/ldifs/groups_and_users.ldif</code></strong></p>
<pre tabindex="0"><code># &#39;Groups&#39; organizational unit
dn: ou=Groups,dc=pygrn,dc=lab
objectclass: organizationalUnit
objectclass: top
ou: Groups

# &#39;wheel&#39; posix group
dn: cn=wheel,ou=Groups,dc=pygrn,dc=lab
cn: wheel
gidnumber: 1250
objectclass: posixGroup
objectclass: top

# &#39;guests&#39; posix group
dn: cn=guests,ou=Groups,dc=pygrn,dc=lab
cn: guests
gidnumber: 1260
objectclass: posixGroup
objectclass: top

# &#39;Users&#39; organizational unit
dn: ou=Users,dc=pygrn,dc=lab
objectclass: organizationalUnit
objectclass: top
ou: Users

# &#39;tw1zr&#39; posix account, member of &#39;wheel&#39;
dn: cn=tw1zr,ou=Users,dc=pygrn,dc=lab
cn: tw1zr
gidnumber: 1250
givenname: tw1zr
homedirectory: /home/tw1zr
loginshell: /bin/bash
objectclass: inetOrgPerson
objectclass: posixAccount
objectclass: top
sn: tw1zr
uid: tw1zr
uidnumber: 1250
userpassword: {MD5}L2vYPpPFMwps3sz3Q0b90A==

# &#39;guest1&#39; posix account, member of &#39;guests&#39;
dn: cn=guest1,ou=Users,dc=pygrn,dc=lab
cn: guest1
gidnumber: 1260
givenname: guest1
homedirectory: /home/guest1
loginshell: /bin/bash
objectclass: inetOrgPerson
objectclass: posixAccount
objectclass: top
sn: guest1
uid: guest1
uidnumber: 1261
userpassword: {MD5}vQ3rQ4oyWpcZcFD5w7dldw==

# &#39;guest2&#39; posix account, member of &#39;guests&#39;
dn: cn=guest2,ou=Users,dc=pygrn,dc=lab
cn: guest2
gidnumber: 1260
givenname: guest2
homedirectory: /home/guest2
loginshell: /bin/bash
objectclass: inetOrgPerson
objectclass: posixAccount
objectclass: top
sn: guest2
uid: guest2
uidnumber: 1262
userpassword: {MD5}ZqXA290kYZ/F6XnHj6RpRw==
</code></pre><h2 id="configuring-ldap-client-role">Configuring LDAP client role</h2>
<p>We&rsquo;re also going to create an independant role which will configure our virtual machines to act as clients of the <strong>LDAP</strong> server. This will make it so that the users and groups we create on <strong>LDAP</strong> are available on <strong>Linux</strong> as if they were natively created on the machines.</p>
<p>Create <code>/path/to/ansible/roles/openldap-client/tasks/main.yml</code> to look like this:</p>
<p><strong><code>$ cat roles/openldap-client/tasks/main.yml</code></strong></p>
<pre tabindex="0"><code>---
- name: Install Linux dependencies for connecting to LDAP server
  apt:
    name: &#34;{{ item }}&#34;
    state: &#34;latest&#34;
    update_cache: &#34;yes&#34;
  with_items:
    - &#34;ldap-utils&#34;
    - &#34;libnss-ldap&#34;
    - &#34;libpam-ldap&#34;
    - &#34;nscd&#34;

- name: Copy openldap.crt into /etc/ssl/pygrn.lab/
  copy:
    src: &#34;CA/openldap.crt&#34;
    dest: &#34;/etc/ssl/pygrn.lab/&#34;
    owner: &#34;root&#34;
    group: &#34;ssl-cert&#34;
    mode: &#34;0664&#34;

- name: Copy openldap.key into /etc/ssl/pygrn.lab/
  copy:
    src: &#34;CA/openldap.key&#34;
    dest: &#34;/etc/ssl/pygrn.lab/&#34;
    owner: &#34;root&#34;
    group: &#34;ssl-cert&#34;
    mode: &#34;0660&#34;

- name: Add nsswitch.conf to /etc/
  copy:
    src: &#34;nsswitch.conf&#34;
    dest: &#34;/etc/&#34;
    owner: &#34;root&#34;
    group: &#34;root&#34;
    mode: &#34;0644&#34;
  register: &#34;add_nsswitch_result&#34;

- name: Add common-session to /etc/pam.d/
  copy:
    src: &#34;common-session&#34;
    dest: &#34;/etc/pam.d/&#34;
    owner: &#34;root&#34;
    group: &#34;root&#34;
    mode: &#34;0644&#34;

- name: Add pam_ldap.conf to /etc/
  copy:
    src: &#34;pam_ldap.conf&#34;
    dest: &#34;/etc/&#34;
    owner: &#34;root&#34;
    group: &#34;root&#34;
    mode: &#34;0644&#34;

- name: Add libnss-ldap.conf to /etc/
  copy:
    src: &#34;libnss-ldap.conf&#34;
    dest: &#34;/etc/&#34;
    owner: &#34;root&#34;
    group: &#34;root&#34;
    mode: &#34;0644&#34;

- name: Add pam_ldap.secret to /etc/
  copy:
    src: &#34;pam_ldap.secret&#34;
    dest: &#34;/etc/&#34;
    owner: &#34;root&#34;
    group: &#34;root&#34;
    mode: &#34;0600&#34;

- name: Add libnss-ldap.secret to /etc/
  copy:
    src: &#34;libnss-ldap.secret&#34;
    dest: &#34;/etc/&#34;
    owner: &#34;root&#34;
    group: &#34;root&#34;
    mode: &#34;0600&#34;

- name: Restart nscd if nsswitch.conf is changed
  when: &#34;add_nsswitch_result.changed&#34;
  systemd:
    name: &#34;nscd&#34;
    state: &#34;restarted&#34;
</code></pre><p>Now here are the contents of these files which are being copied by the <code>openldap-client</code> role, I&rsquo;ll <strong>cat</strong> them and drop the output. They all go inside the <code>/path/to/ansible/files/</code> directory so <strong>Ansible</strong> can access them and copy them over to our virtual machines when the playbook is executed.</p>
<p><strong><code>$ cat files/nsswitch.conf</code></strong></p>
<pre tabindex="0"><code>passwd:         files ldap
group:          files ldap
shadow:         files ldap
gshadow:        files

hosts:          files dns
networks:       files

protocols:      db files
services:       db files
ethers:         db files
rpc:            db files

netgroup:       nis
</code></pre><p><strong><code>$ cat files/common-session</code></strong></p>
<pre tabindex="0"><code>session [default=1]   pam_permit.so
session requisite     pam_deny.so
session required      pam_permit.so
session required      pam_unix.so
session optional      pam_systemd.so
session required      pam_mkhomedir.so skel=/etc/skel umask=077
</code></pre><p><strong><code>$ cat files/pam_ldap.conf</code></strong></p>
<pre tabindex="0"><code>base dc=pygrn,dc=lab
uri ldap://cutxn.pygrn.lab ldap://cutxo.pygrn.lab
ldap_version 3
binddn cn=readonly,dc=pygrn,dc=lab
bindpw aayn
rootbinddn cn=admin,dc=pygrn,dc=lab
port 389

pam_password crypt

ssl start_tls
tls_checkpeer yes
tls_cacertfile /etc/ssl/pygrn.lab/pygrn.lab-CA.crt
tls_cert /etc/ssl/pygrn.lab/openldap.crt
tls_key /etc/ssl/pygrn.lab/openldap.key
</code></pre><p><strong><code>$ cat files/libnss-ldap.conf</code></strong></p>
<pre tabindex="0"><code>base dc=pygrn,dc=lab
uri ldap://cutxn.pygrn.lab ldap://cutxo.pygrn.lab
ldap_version 3
binddn cn=readonly,dc=pygrn,dc=lab
bindpw aayn
rootbinddn cn=admin,dc=pygrn,dc=lab
port 389

ssl start_tls
tls_checkpeer yes
tls_cacertfile /etc/ssl/pygrn.lab/pygrn.lab-CA.crt
tls_cert /etc/ssl/pygrn.lab/openldap.crt
tls_key /etc/ssl/pygrn.lab/openldap.key
</code></pre><p>The <code>pam_ldap.secret</code> and <code>libnss-pam.secret</code> files both just hold the rootdn password of the <strong>LDAP</strong> server. This is useful to make root on every box behave like <strong>cn=admin</strong>. I&rsquo;ll simply use &lsquo;<strong>nyaa</strong>&rsquo; as password because this is a test environment.</p>
<pre tabindex="0"><code>$ echo -n &#39;nyaa&#39; | tee pam_ldap.secret &gt; libnss-ldap.secret
</code></pre><p>The <code>openldap.crt</code> and <code>openldap.key</code> files are the certificate and key we created so we could use <strong>TLS</strong> with <strong>OpenLDAP</strong>.</p>
<p>Before running the playbook again, let&rsquo;s create the <code>global_finalizing</code> role. For now this role will only make sure some systemd services are enabled and running on the virtual machines.</p>
<h2 id="finalization-role">Finalization role</h2>
<p>This doesn&rsquo;t mean we won&rsquo;t create any more roles by the way, not even close. I just like to have a role that runs before all the others and a role that runs after. Helps me with organization.</p>
<p>Create <code>roles/global_finalizing/tasks/main.yml</code> with these lines:</p>
<pre tabindex="0"><code>---
- name: Make sure some services are started and enabled
  systemd:
    name: &#34;{{ item }}&#34;
    state: &#34;started&#34;
    enabled: &#34;yes&#34;
  with_items:
    - &#34;docker&#34;
    - &#34;nscd&#34;
    - &#34;sshd&#34;
</code></pre><h2 id="running-the-playbook-after-the-new-changes">Running the playbook after the new changes</h2>
<p>Let&rsquo;s make sure our <strong>playbook.yml</strong> file looks like this:</p>
<p><strong><code>$ cat playbook.yml</code></strong></p>
<pre tabindex="0"><code>---
- name: &#34;Preparation&#34;
  hosts: all
  roles:
    - &#34;global_preparation&#34;

- name: &#34;OpenLDAP Server&#34;
  hosts: ldap
  gather_facts: &#34;no&#34;
  roles:
    - &#34;openldap&#34;

- name: &#34;OpenLDAP Clients&#34;
  hosts: all
  gather_facts: &#34;no&#34;
  roles:
    - &#34;openldap-client&#34;

- name: &#34;Finilizing&#34;
  hosts: all
  gather_facts: &#34;no&#34;
  roles:
    - &#34;global_finalizing&#34;
</code></pre><p>Now run the playbook again, once finished we will have a pair of <strong>LDAP</strong> servers in two different VMs with master/master replication.</p>
<p>When the playbook finishes running we&rsquo;ll try to connect to the <strong>LDAP</strong> server with the <strong>phpLDAPadmin</strong> front-end we deployed earlier.</p>
<p>Recreate the <strong>ssh</strong> tunnel to access the virtual machine on port 6080:</p>
<pre tabindex="0"><code>$ ssh -L 6080:192.168.122.2:6080 root@[IP of hypervisor] -N
</code></pre><p>Open a web browser and go to <strong>localhost:6080</strong>. When the page loads try to login into the <strong>LDAP</strong> server with the credentials we defined for the <strong>Docker</strong> container.</p>
<p><img src="/blog/sysadmin-playground/4.png" alt=""></p>
<h2 id="modifying-the-ldap-server">Modifying the LDAP server</h2>
<p>We could do whatever modification we wanted through the <strong>PHP</strong> front-end, but we&rsquo;re going to use the command line to apply the ldif files we copied into the machines with <strong>Ansible</strong> in the earlier role.</p>
<p>Log into <strong>cutxn</strong> through <strong>ssh</strong> and apply the first ldif file with this command:</p>
<pre tabindex="0"><code>ldapmodify -ZZ -H ldap://cutxn.pygrn.lab -D cn=admin,cn=config -w nyaa -f /srv/openldap/ldifs/auth_and_tls.ldif
</code></pre><p>The <strong>auth_and_tls.ldif</strong> file modifies the <strong>cn=config</strong> so that anonymous binds are not allowed and explicit authentication is required instead. If you look at the <strong>Ansible</strong> task where we defined credentials for <strong>LDAP</strong> there is a read-only account which will be used to query the directory structure and retrieve users/groups. It also disallows any connection which isn&rsquo;t using <strong>TLS</strong>.<br>
Now apply the second ldif with this command:</p>
<pre tabindex="0"><code>ldapadd -ZZ -H ldap://cutxn.pygrn.lab -D cn=admin,dc=pygrn,dc=lab -w nyaa -f /srv/openldap/ldifs/groups_and_users.ldif
</code></pre><p>The <code>groups_and_users.ldif</code> file adds two organizational units (OU): <strong>Groups</strong> and <strong>Users</strong>; then adds two posix groups under <strong>ou=Groups</strong>: <strong>wheel</strong> and <strong>guests</strong>; and three posix users under <strong>ou=Users</strong>: <strong>tw1zr</strong>, <strong>guest1</strong> and <strong>guest2</strong>. Here&rsquo;s a diagram depicting it:</p>
<p><img src="/blog/sysadmin-playground/5.png" alt=""></p>
<p>The dotted lines at the bottom denote which posix users belong to which posix groups, this is accomplished by setting the users&rsquo; GID number to the same as the group you want them to belong to (re-read the ldif file).</p>
<p>Let&rsquo;s do an <strong>ldapsearch</strong> to check our changes were applied correctly; we&rsquo;ll also do the search pointing at <strong>cutxo</strong> instead of <strong>cutxn</strong> to check that replication is working:</p>
<p>The following command queries the cn=config and uses <strong>grep</strong> to filter the output so it only displays the olc parameters to do with anonymous binds, <strong>TLS</strong> requirement and authentication requirement:</p>
<p><strong><code>$ ldapsearch -ZZ -H ldap://cutxo.pygrn.lab -D cn=admin,cn=config -w nyaa -b cn=config | grep 'olcDisallows:\|olcSecurity:\|olcRequires:'</code></strong></p>
<pre tabindex="0"><code>olcDisallows: bind_anon
olcSecurity: tls=1
olcRequires: authc
</code></pre><p>Now I&rsquo;ll run another <strong>ldapsearch</strong> to query the entire DN:</p>
<pre tabindex="0"><code>$ ldapsearch -ZZ -H ldap://cutxo.pygrn.lab -D cn=admin,dc=pygrn,dc=lab -w nyaa -b dc=pygrn,dc=lab
</code></pre><p>The output of that command shows the extended ldif of the entire DN. We can also check this through that <strong>phpLDAPadmin</strong> front-end we deployed.</p>
<p><img src="/blog/sysadmin-playground/6.gif" alt=""></p>
<p>Let&rsquo;s log into the three VMs through <strong>ssh</strong> using the three different users we created on the <strong>LDAP</strong> server. We added passwords encoded in MD5 in the <code>groups_and_users.ldif</code> file, I&rsquo;ll type them here now in plain text so we can use them to <strong>ssh</strong> into the boxes:</p>
<p>root:nyaa
tw1zr:nyaa
guest1:yugi
guest2:yigo</p>
<p>Authenticating as <strong>tw1zr</strong>: <img src="/blog/sysadmin-playground/7.0.png" alt=""></p>
<p>Authenticating as <strong>guest1</strong>: <img src="/blog/sysadmin-playground/7.1.png" alt=""></p>
<p>Authenticating as <strong>guest2</strong>: <img src="/blog/sysadmin-playground/7.2.png" alt=""></p>
<p>None of these accounts were created on the <strong>Linux</strong> machines, <strong>Linux</strong> is just querying the <strong>LDAP</strong> server and allowing the posix accounts there to access the machine as if they were local, this is what our configuration files are accomplishing.<br>
I also ran <code>sudo -l</code> as <strong>tw1zr</strong> to make sure our <strong>sudo</strong> privileges were working properly; we defined all the users in the wheel group to be able to run <strong>sudo</strong> commands without a password.</p>
<p>Many services out there are designed to be compatible with <strong>LDAP</strong> authentication. We will likely use it again when we deploy further services.</p>
</article>
</main>
<footer>
<p>licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0">cc by-nc-sa 4.0</a></br>
standing up for freedom </p>
</footer>
</body>
</html>

